
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mein DeutschBuddy</title>
  <!-- Basit, tek sayfa; inline script kullandƒ±ƒüƒ±mƒ±z i√ßin katƒ± CSP koymuyoruz.
       XSS'i zaten innerHTML kullanmayarak engelliyoruz. -->
  <style>
    :root { --blue:#4461ff; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#eaf0ff;color:#222;margin:0;padding:20px;text-align:center}
    h1{color:var(--blue);margin:8px 0 4px}
    p.small{opacity:.75;margin:0 0 12px}
    .wrap{max-width:900px;margin:0 auto}
    textarea{width:100%;height:120px;border-radius:10px;border:2px solid var(--blue);padding:10px;font-size:16px;background:#fff;margin:6px 0}
    .controls{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:10px 0 6px}
    .btn{background:var(--blue);color:#fff;border:none;border-radius:10px;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn.alt{background:#6b7cff}
    .status{font-size:.9rem;opacity:.8;min-height:1.2em;margin:4px 0 8px}
    .card{background:#fff;border-radius:12px;box-shadow:0 4px 8px rgba(0,0,0,.1);padding:14px;margin:12px auto;text-align:left}
    .line{padding-left:10px;margin:6px 0;border-left:6px solid #999}
    .line.de{border-color:var(--blue)}
    .pillbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .pill{background:#eef2ff;border:1px solid var(--blue);color:var(--blue);border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer;user-select:none}
    .pill:active{transform:scale(.98)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mein DeutschBuddy üíô</h1>
    <p class="small">Paste German & English. Press <b>Show</b>. Use <b>Play / Stop / Restart</b> or per-sentence <b>Auto from here</b>.</p>

    <textarea id="deInput" placeholder="üá©üá™ German sentences here..."></textarea>
    <textarea id="enInput" placeholder="üá¨üáß English translations here..."></textarea>

    <div class="controls">
      <button id="btnShow" class="btn">Show</button>
      <button id="btnPlay" class="btn">‚ñ∂ Play</button>
      <button id="btnStop" class="btn alt">‚èπ Stop</button>
      <button id="btnRestart" class="btn alt">‚èÆ Restart</button>
    </div>
    <div id="status" class="status"></div>

    <div id="list"></div>
  </div>

  <script>
  'use strict';

  // ---- state ----
  let currentIndex = 0;
  let autoMode = false;
  let lastStoppedIndex = 0;
  let hasUserGesture = false;  // tarayƒ±cƒ±larƒ±n ilk √ßalma i√ßin dokunu≈ü ≈üartƒ±
  let speaking = false;

  // ---- helpers ----
  const $ = sel => document.querySelector(sel);
  const listEl = $('#list');
  const statusEl = $('#status');

  function setStatus(msg) {
    statusEl.textContent = msg || '';
  }

  function splitSentences(txt) {
    // . ! ? ile b√∂l, bo≈üluklarƒ± sadele
    const parts = (txt || '')
      .replace(/\s+/g, ' ')
      .trim()
      .match(/[^.!?]+[.!?]?/g) || [];
    return parts.map(s => s.trim()).filter(Boolean);
  }

  function stopSpeaking(saveIndex = true) {
    autoMode = false;
    speaking = false;
    try { window.speechSynthesis.cancel(); } catch {}
    if (saveIndex) lastStoppedIndex = currentIndex;
  }

  function speak(text, lang, rate, onend) {
    if (!('speechSynthesis' in window)) {
      setStatus('Your browser does not support speechSynthesis.');
      return;
    }
    if (!hasUserGesture) {
      setStatus('Tap any button once, then Play (browser gesture required).');
      return;
    }
    if (!text) { if (onend) onend(); return; }

    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang;
    u.rate = rate;
    u.onstart = () => { speaking = true; };
    u.onend = () => { speaking = false; if (onend) onend(); };
    u.onerror = () => { speaking = false; if (onend) onend(); };

    window.speechSynthesis.speak(u);
  }

  function playPairDEEN(de, en, done) {
    // sƒ±ralƒ±: DE ‚Üí EN ‚Üí DE ‚Üí EN, sonra done()
    speak(de, 'de-DE', 0.7, () => {
      speak(en, 'en-US', 0.8, () => {
        speak(de, 'de-DE', 0.7, () => {
          speak(en, 'en-US', 0.8, () => { if (done) done(); });
        });
      });
    });
  }

  function playNext() {
    if (!autoMode) return;

    const deArr = splitSentences($('#deInput').value);
    const enArr = splitSentences($('#enInput').value);

    if (currentIndex >= deArr.length) {
      autoMode = false;
      setStatus('Finished.');
      return;
    }

    const de = deArr[currentIndex] || '';
    const en = enArr[currentIndex] || '';
    if (!de) { currentIndex++; playNext(); return; }

    setStatus(`Playing ${currentIndex+1}/${deArr.length} ‚Ä¶`);
    playPairDEEN(de, en, () => {
      if (!autoMode) return;
      currentIndex++;
      playNext();
    });
  }

  function playAll() {
    stopSpeaking(false);
    currentIndex = (lastStoppedIndex || 0);
    autoMode = true;
    playNext();
  }

  function restartAll() {
    stopSpeaking(false);
    currentIndex = 0;
    lastStoppedIndex = 0;
    autoMode = true;
    playNext();
  }

  function playFrom(i) {
    stopSpeaking(false);
    currentIndex = i;
    autoMode = true;
    playNext();
  }

  // ---- render list ----
  function renderList() {
    const deArr = splitSentences($('#deInput').value);
    const enArr = splitSentences($('#enInput').value);
    listEl.innerHTML = '';

    deArr.forEach((de, i) => {
      if (!de) return;
      const en = enArr[i] || '';

      const card = document.createElement('div');
      card.className = 'card';

      const lineDe = document.createElement('div');
      lineDe.className = 'line de';
      lineDe.textContent = `üá©üá™ ${de}`;

      const lineEn = document.createElement('div');
      lineEn.className = 'line';
      lineEn.textContent = `üá¨üáß ${en}`;

      const bar = document.createElement('div');
      bar.className = 'pillbar';

      const bDe = document.createElement('button');
      bDe.className = 'pill';
      bDe.type = 'button';
      bDe.textContent = 'üîä German';
      bDe.addEventListener('click', () => {
        hasUserGesture = true;
        stopSpeaking(false);
        speak(de, 'de-DE', 0.8);
      });

      const bEn = document.createElement('button');
      bEn.className = 'pill';
      bEn.type = 'button';
      bEn.textContent = 'üîä English';
      bEn.addEventListener('click', () => {
        hasUserGesture = true;
        stopSpeaking(false);
        speak(en, 'en-US', 0.9);
      });

      const bAuto = document.createElement('button');
      bAuto.className = 'pill';
      bAuto.type = 'button';
      bAuto.textContent = '‚ñ∂ Auto from here';
      bAuto.addEventListener('click', () => {
        hasUserGesture = true;
        playFrom(i);
      });

      bar.appendChild(bDe);
      bar.appendChild(bEn);
      bar.appendChild(bAuto);

      card.appendChild(lineDe);
      card.appendChild(lineEn);
      card.appendChild(bar);
      listEl.appendChild(card);
    });

    setStatus(`Loaded ${deArr.length} sentence(s).`);
  }

  // ---- events ----
  $('#btnShow').addEventListener('click', () => { hasUserGesture = true; renderList(); });
  $('#btnPlay').addEventListener('click', () => { hasUserGesture = true; playAll(); });
  $('#btnStop').addEventListener('click', () => { hasUserGesture = true; stopSpeaking(); setStatus('Stopped.'); });
  $('#btnRestart').addEventListener('click', () => { hasUserGesture = true; restartAll(); });

  // kullanƒ±cƒ± ilk dokunu≈üunu yakala
  document.addEventListener('pointerdown', () => { hasUserGesture = true; }, { once:true });
  </script>
</body>
</html>
